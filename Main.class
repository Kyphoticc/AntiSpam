package me.benzplayz;

import java.util.HashSet;
import java.util.Set;
import java.util.logging.Logger;
import org.bukkit.ChatColor;
import org.bukkit.Server;
import org.bukkit.command.Command;
import org.bukkit.command.CommandSender;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.AsyncPlayerChatEvent;
import org.bukkit.plugin.PluginManager;
import org.bukkit.plugin.java.JavaPlugin;
import org.bukkit.scheduler.BukkitScheduler;

public class Main
  extends JavaPlugin
  implements Listener
{
  Set<String> antispam = new HashSet();
  long time;
  String message;
  String noperm;
  String mreload;
  
  public void onEnable()
  {
    PluginManager pm = getServer().getPluginManager();
    pm.registerEvents(this, this);
    getLogger().info("[AntiSpam] enable");
    saveDefaultConfig();
  }
  
  public void onDisable()
  {
    getLogger().info("[AntiSpam] disable");
    saveDefaultConfig();
  }
  
  public boolean onCommand(CommandSender sender, Command cmd, String label, String[] args)
  {
    this.noperm = getConfig().getString("noperm", ChatColor.GREEN + "You must be an Owner to do this");
    this.noperm = this.noperm.replace("&", "?");
    this.noperm = this.noperm.replace("''", "'");
    
    this.mreload = getConfig().getString("mreload", "This plugin as been reload!");
    this.mreload = this.mreload.replace("&", "?");
    this.mreload = this.mreload.replace("''", "'");
    this.mreload = (ChatColor.GREEN + "[Host]: " + this.mreload);
    if (label.equalsIgnoreCase("asreload"))
    {
      if (sender.hasPermission("antispam.reload"))
      {
        reloadConfig();
        saveDefaultConfig();
        sender.sendMessage(this.mreload);
      }
      else
      {
        sender.sendMessage(this.noperm);
      }
    }
    else if (label.equalsIgnoreCase("as"))
    {
      sender.sendMessage("?6--------------?cNoSpam?6--------------");
      sender.sendMessage("?6Plugin by BenzPlayzMC");
      sender.sendMessage("?6------------------------------------------");
    }
    return false;
  }
  
  @EventHandler
  public void onPlayerChat(AsyncPlayerChatEvent e)
  {
    final Player player = e.getPlayer();
    this.message = getConfig().getString("message", ChatColor.GREEN + "You can only chat every 3 seconds. Buying a rank disables this.");
    this.message = this.message.replace("&", "?");
    this.message = this.message.replace("''", "'");
    this.message = (ChatColor.GREEN + "[Host]: " + this.message);
    
    this.time = getConfig().getLong("time");
    this.time *= 20L;
    
    boolean spamhas = this.antispam.contains(player.getName());
    if (!player.hasPermission("antispam.bypass")) {
      if (!spamhas)
      {
        this.antispam.add(player.getName());
        getServer().getScheduler().scheduleSyncDelayedTask(this, new Runnable()
        {
          public void run()
          {
            Main.this.antispam.remove(player.getName());
          }
        }, this.time);
      }
      else
      {
        e.setCancelled(true);
        player.sendMessage(this.message);
      }
    }
  }
}
